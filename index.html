<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIELCA - Monitor Fotovoltaico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            padding: 24px;
            color: #111827;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 32px;
            margin-bottom: 24px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .header-title p {
            color: #6b7280;
            font-size: 14px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #ecfdf5;
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 14px;
            color: #059669;
            font-weight: 500;
        }

        .live-indicator.offline {
            background: #fee2e2;
            color: #dc2626;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .live-indicator.offline .live-dot {
            background: #dc2626;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timestamp {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            border-radius: 12px;
            padding: 24px;
            border: 2px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .stat-card.yellow {
            background: #fef9c3;
            border-color: #fde047;
        }

        .stat-card.blue {
            background: #dbeafe;
            border-color: #93c5fd;
        }

        .stat-card.green {
            background: #d1fae5;
            border-color: #6ee7b7;
        }

        .stat-card.red {
            background: #fee2e2;
            border-color: #fca5a5;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .stat-value {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 8px;
        }

        .stat-value .number {
            font-size: 32px;
            font-weight: bold;
            color: #111827;
        }

        .stat-value .unit {
            font-size: 16px;
            font-weight: 500;
            opacity: 0.7;
        }

        .stat-label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }

        .alarms-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .alarm-card {
            border-radius: 8px;
            padding: 16px;
            border: 2px solid;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .alarm-card.red {
            background: #fee2e2;
            border-color: #dc2626;
            color: #991b1b;
        }

        .alarm-card.orange {
            background: #fed7aa;
            border-color: #f97316;
            color: #9a3412;
        }

        .alarm-card.yellow {
            background: #fef3c7;
            border-color: #eab308;
            color: #854d0e;
        }

        .alarm-card.blue {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alarm-type {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alarm-count {
            font-size: 24px;
            font-weight: bold;
        }

        .energy-flow {
            position: relative;
            height: 500px;
            background: linear-gradient(to bottom, #f0f9ff 0%, #ffffff 100%);
            border-radius: 12px;
            overflow: hidden;
        }

        .flow-node {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            border: 2px solid #d1d5db;
            padding: 16px;
            min-width: 180px;
            z-index: 10;
        }

        .flow-node.active {
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.5); }
        }

        .flow-node-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .flow-icon {
            width: 32px;
            height: 32px;
        }

        .flow-node-title {
            font-weight: bold;
            font-size: 14px;
            color: #111827;
        }

        .flow-node-status {
            font-size: 11px;
            color: #6b7280;
        }

        .flow-node-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .flow-node-value {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .flow-node-value .number {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
        }

        .flow-node-value .unit {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .node-solar {
            top: 30px;
            right: 80px;
        }

        .node-battery {
            top: 200px;
            left: 40px;
        }

        .node-grid {
            top: 30px;
            left: 80px;
        }

        .node-load {
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
        }

        .flow-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .flow-line {
            stroke: #2563eb;
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 10;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -20;
            }
        }

        .env-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .env-card {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-radius: 8px;
            background: #ecfdf5;
            border: 1px solid #6ee7b7;
        }

        .env-icon {
            width: 32px;
            height: 32px;
            color: #059669;
            flex-shrink: 0;
        }

        .env-value {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .env-value .number {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
        }

        .env-value .unit {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .env-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .footer {
            text-align: center;
            margin-top: 32px;
        }

        .footer-brand {
            font-size: 14px;
            color: #6b7280;
        }

        .footer-brand strong {
            color: #2563eb;
            font-weight: 600;
        }

        .footer-tagline {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .icon {
            display: inline-block;
            vertical-align: middle;
        }

        .stack-gap {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>DIELCA</h1>
                </div>
                <div>
                    <div class="live-indicator" id="live-indicator">
                        <span class="live-dot"></span>
                        <span id="live-text">Datos en vivo</span>
                    </div>
                    <div class="timestamp" id="timestamp">--</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card yellow">
                <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <div class="stat-value">
                    <span class="number" id="energia-hoy">--</span>
                    <span class="unit">kWh</span>
                </div>
                <div class="stat-label">Rendimiento hoy</div>
            </div>

            <div class="stat-card blue">
                <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <div class="stat-value">
                    <span class="number" id="uso-total">--</span>
                    <span class="unit">kW</span>
                </div>
                <div class="stat-label">Uso total actual</div>
            </div>

            <div class="stat-card green">
                <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
                <div class="stat-value">
                    <span class="number" id="energia-total">--</span>
                    <span class="unit">MWh</span>
                </div>
                <div class="stat-label">Rendimiento total</div>
            </div>

            <div class="stat-card red">
                <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="stat-value">
                    <span class="number" id="autoconsumo">--</span>
                    <span class="unit">kW</span>
                </div>
                <div class="stat-label">Autoconsumo actual</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="stack-gap">
                <div class="card">
                    <h3 class="card-title">Estado del Sistema</h3>
                    <div class="alarms-grid">
                        <div class="alarm-card red">
                            <div class="alarm-type">Críticas</div>
                            <div class="alarm-count">0</div>
                        </div>
                        <div class="alarm-card orange">
                            <div class="alarm-type">Mayor</div>
                            <div class="alarm-count">0</div>
                        </div>
                        <div class="alarm-card yellow">
                            <div class="alarm-type">Menores</div>
                            <div class="alarm-count">0</div>
                        </div>
                        <div class="alarm-card blue">
                            <div class="alarm-type">Aviso</div>
                            <div class="alarm-count">0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <svg class="icon" style="width: 20px; height: 20px; margin-right: 8px; color: #059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                        </svg>
                        Beneficios Medioambientales
                    </h3>
                    <div class="env-grid">
                        <div class="env-card">
                            <svg class="env-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                            </svg>
                            <div>
                                <div class="env-value">
                                    <span class="number" id="carbon-saved">--</span>
                                    <span class="unit">toneladas</span>
                                </div>
                                <div class="env-label">Ahorro estándar de carbón</div>
                            </div>
                        </div>

                        <div class="env-card">
                            <svg class="env-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                            </svg>
                            <div>
                                <div class="env-value">
                                    <span class="number" id="co2-saved">--</span>
                                    <span class="unit">toneladas</span>
                                </div>
                                <div class="env-label">CO₂ evitado</div>
                            </div>
                        </div>

                        <div class="env-card">
                            <svg class="env-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                            </svg>
                            <div>
                                <div class="env-value">
                                    <span class="number" id="trees">--</span>
                                    <span class="unit"></span>
                                </div>
                                <div class="env-label">Árboles equivalentes plantados</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">
                    <svg class="icon" style="width: 20px; height: 20px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Flujo de Energía en Tiempo Real
                </h3>
                <div class="energy-flow">
                    <svg class="flow-svg" id="flowSvg"></svg>

                    <div class="flow-node node-solar active" id="node-solar">
                        <div class="flow-node-header">
                            <svg class="flow-icon" style="color: #ca8a04;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                            <div>
                                <div class="flow-node-title">Paneles Solares</div>
                            </div>
                        </div>
                        <div class="flow-node-label">Potencia de salida</div>
                        <div class="flow-node-value">
                            <span class="number" id="solar-power">0.000</span>
                            <span class="unit">kW</span>
                        </div>
                    </div>

                    <div class="flow-node node-battery" id="node-battery">
                        <div class="flow-node-header">
                            <svg class="flow-icon" style="color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            <div>
                                <div class="flow-node-title">Batería</div>
                                <div class="flow-node-status">Sin control</div>
                            </div>
                        </div>
                        <div class="flow-node-label">Energía actual</div>
                        <div class="flow-node-value">
                            <span class="number" id="battery-power">0.000</span>
                            <span class="unit">kW</span>
                        </div>
                        <div class="flow-node-label" style="margin-top: 8px;">SOC: <span id="battery-soc">0.0</span>%</div>
                    </div>

                    <div class="flow-node node-grid" id="node-grid">
                        <div class="flow-node-header">
                            <svg class="flow-icon" style="color: #dc2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <div>
                                <div class="flow-node-title">Red Eléctrica</div>
                            </div>
                        </div>
                        <div class="flow-node-label">Compra de red</div>
                        <div class="flow-node-value">
                            <span class="number" id="grid-power">0.000</span>
                            <span class="unit">kW</span>
                        </div>
                    </div>

                    <div class="flow-node node-load active" id="node-load">
                        <div class="flow-node-header">
                            <svg class="flow-icon" style="color: #059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                            </svg>
                            <div>
                                <div class="flow-node-title">Edificio / Carga</div>
                            </div>
                        </div>
                        <div class="flow-node-label">Energía de consumo</div>
                        <div class="flow-node-value">
                            <span class="number" id="load-power">0.000</span>
                            <span class="unit">kW</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p class="footer-brand">
                <strong>DIELCA</strong> - Distribución de Material Eléctrico
            </p>
            <p class="footer-tagline">40 años de experiencia en Canarias</p>
        </div>
    </div>

<script>
let data = null
let lastUpdateTime = null
const UPDATE_INTERVAL = 60000

const CARBON_PER_MWH = 0.4
const CO2_PER_MWH = 0.475
const TREES_PER_TON_CO2 = 1.39

const clamp = (v, min, max) => Math.min(max, Math.max(min, v))
const toNum = (v, d = 0) => {
  const n = Number(String(v ?? '').replace(',', '.'))
  return Number.isFinite(n) ? n : d
}

async function loadData() {
  try {
    const timestamp = new Date().getTime()
    const response = await fetch(`datos.json?t=${timestamp}`, {
      method: 'GET',
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    })

    if (!response.ok) throw new Error(`HTTP ${response.status}`)

    data = await response.json()
    lastUpdateTime = new Date()
    updateUI()
    updateLiveIndicator(true)
  } catch (e) {
    updateLiveIndicator(false)
  }
}

function updateLiveIndicator(isOnline) {
  const indicator = document.getElementById('live-indicator')
  const liveText = document.getElementById('live-text')

  if (isOnline) {
    indicator.classList.remove('offline')
    liveText.textContent = 'Datos en vivo'
  } else {
    indicator.classList.add('offline')
    liveText.textContent = 'Sin conexión'
  }
}

function updateUI() {
  if (!data) return

  const energiaHoyKwh = Math.max(0, toNum(data?.total?.energia_hoy, 0))
  const energiaTotalKwh = Math.max(0, toNum(data?.total?.energia_total, 0))

  const solarPower = Math.max(0, toNum(data?.sebadal?.potencia ?? data?.total?.potencia, 0))
  const loadPower = Math.max(0, toNum(data?.sebadal?.uso_total, 0))

  let gridPower = Math.max(0, toNum(data?.sebadal?.compra_red, 0))
  const rawGrid = toNum(data?.sebadal?.compra_red, 0)
  if (0 < rawGrid && rawGrid <= 1.2 && loadPower > 0) gridPower = loadPower * clamp(rawGrid, 0, 1)

  let autoconsumo = Math.max(0, toNum(data?.sebadal?.autoconsumo, 0))
  if (autoconsumo <= 0 && solarPower > 0 && loadPower > 0) autoconsumo = Math.min(solarPower, loadPower)
  autoconsumo = clamp(autoconsumo, 0, Math.min(solarPower || autoconsumo, loadPower || autoconsumo) || autoconsumo)

  const exportPower = Math.max(0, toNum(data?.sebadal?.exportacion_red, Math.max(0, solarPower - autoconsumo)))

  document.getElementById('energia-hoy').textContent = energiaHoyKwh.toFixed(2)
  document.getElementById('energia-total').textContent = (energiaTotalKwh / 1000).toFixed(2)
  document.getElementById('uso-total').textContent = loadPower.toFixed(2)
  document.getElementById('autoconsumo').textContent = autoconsumo.toFixed(2)
  document.getElementById('timestamp').textContent = data?.actualizado || '--'

  document.getElementById('solar-power').textContent = solarPower.toFixed(3)
  document.getElementById('load-power').textContent = loadPower.toFixed(3)
  document.getElementById('grid-power').textContent = gridPower.toFixed(3)

  const batteryKw = toNum(data?.sebadal?.bateria_kw, 0)
  const batterySoc = toNum(data?.sebadal?.bateria_soc, 0)
  document.getElementById('battery-power').textContent = batteryKw.toFixed(3)
  document.getElementById('battery-soc').textContent = clamp(batterySoc, 0, 100).toFixed(1)

  const totalMWh = energiaTotalKwh / 1000
  const carbonSaved = totalMWh * CARBON_PER_MWH
  const co2Saved = totalMWh * CO2_PER_MWH
  const treesEquivalent = Math.round(co2Saved * TREES_PER_TON_CO2)

  document.getElementById('carbon-saved').textContent = carbonSaved.toFixed(2)
  document.getElementById('co2-saved').textContent = co2Saved.toFixed(2)
  document.getElementById('trees').textContent = treesEquivalent

  drawFlowLines({
    solarPower,
    loadPower,
    gridPower,
    batteryKw,
    autoconsumo,
    exportPower
  })
}

function getNodeCenter(el) {
  const r = el.getBoundingClientRect()
  const parent = el.closest('.energy-flow').getBoundingClientRect()
  return {
    x: (r.left - parent.left) + r.width / 2,
    y: (r.top - parent.top) + r.height / 2
  }
}

function svgPath(a, b) {
  const dx = (b.x - a.x) * 0.5
  const c1 = { x: a.x + dx, y: a.y }
  const c2 = { x: b.x - dx, y: b.y }
  return `M ${a.x} ${a.y} C ${c1.x} ${c1.y}, ${c2.x} ${c2.y}, ${b.x} ${b.y}`
}

function drawFlowLines({ solarPower, loadPower, gridPower, batteryKw, autoconsumo, exportPower }) {
  const svg = document.getElementById('flowSvg')
  if (!svg) return

  const solarEl = document.getElementById('node-solar')
  const loadEl = document.getElementById('node-load')
  const gridEl = document.getElementById('node-grid')
  const battEl = document.getElementById('node-battery')

  const solar = getNodeCenter(solarEl)
  const load = getNodeCenter(loadEl)
  const grid = getNodeCenter(gridEl)
  const batt = getNodeCenter(battEl)

  const lines = []

  const toLoad = autoconsumo > 0 ? autoconsumo : (solarPower > 0 && loadPower > 0 ? Math.min(solarPower, loadPower) : 0)
  const fromGrid = gridPower > 0 ? gridPower : 0

  if (toLoad > 0.01) lines.push({ from: solar, to: load })
  if (fromGrid > 0.01) lines.push({ from: grid, to: load })
  if (batteryKw > 0.01) lines.push({ from: batt, to: load })
  if (exportPower > 0.01) lines.push({ from: solar, to: grid })

  svg.setAttribute('viewBox', `0 0 ${svg.clientWidth} ${svg.clientHeight}`)
  svg.innerHTML = lines.map(l => `<path class="flow-line" d="${svgPath(l.from, l.to)}"></path>`).join('')

  solarEl.classList.toggle('active', solarPower > 0.01)
  loadEl.classList.toggle('active', loadPower > 0.01)
}

function tickOfflineGuard() {
  if (!lastUpdateTime) return
  const ms = Date.now() - lastUpdateTime.getTime()
  if (ms > UPDATE_INTERVAL * 2.2) updateLiveIndicator(false)
}

loadData()
setInterval(loadData, UPDATE_INTERVAL)
setInterval(tickOfflineGuard, 5000)
window.addEventListener('resize', () => {
  if (!data) return
  updateUI()
})
</script>
</body>
</html>