```html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="refresh" content="3600" />
  <title>Simulaci√≥n | Alimentaci√≥n Solar + Red</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a30;
      --panel2:#0c162b;
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --blue:#60a5fa;
      --violet:#a78bfa;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:16px;
      --ring: 0 0 0 3px rgba(96,165,250,.25);
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(96,165,250,.25), transparent 55%),
                  radial-gradient(1000px 700px at 80% 20%, rgba(167,139,250,.18), transparent 60%),
                  radial-gradient(900px 700px at 30% 90%, rgba(45,212,191,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: var(--font);
      overflow:hidden;
    }

    .stage{
      height:100%;
      display:grid;
      grid-template-rows: 68px 1fr 72px;
      gap:12px;
      padding: 12px;
      box-sizing:border-box;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px 14px;
      gap: 12px;
      min-width: 0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .badge{
      width:42px;
      height:42px;
      border-radius:12px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, rgba(251,191,36,.20), rgba(96,165,250,.18));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      flex:0 0 auto;
    }

    .title{
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .title h1{
      margin:0;
      font-size: 16px;
      font-weight: 700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .subtitle{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }

    .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(45,212,191,.18);
    }

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }

    .btn:focus-visible{ outline:none; box-shadow: var(--ring); }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.18); }

    main{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      min-height:0;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .panel-inner{
      height:100%;
      display:grid;
      grid-template-rows: auto 1fr;
      min-height:0;
    }

    .panel-head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .panel-head h2{
      margin:0;
      font-size: 13px;
      font-weight: 700;
      color: rgba(255,255,255,.9);
      letter-spacing:.2px;
    }

    .panel-head small{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .diagram-wrap{
      padding: 8px 10px 12px;
      min-height:0;
      display:grid;
      grid-template-rows: 1fr auto;
      gap:10px;
    }

    .diagram{
      min-height:0;
      width:100%;
      height:100%;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(11,18,32,.75), rgba(11,18,32,.35));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }

    svg{
      width:100%;
      height:100%;
      display:block;
    }

    .kpi-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }

    .kpi{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .kpi .label{
      font-size: 11px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .kpi .value{
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .kpi .sub{
      font-size: 11px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .side{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap:12px;
      min-height:0;
    }

    .cards{
      padding: 12px 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      min-height:0;
      overflow:auto;
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      display:grid;
      gap:10px;
    }

    .card-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .card-top strong{
      font-size: 12px;
      letter-spacing:.2px;
    }

    .chip{
      font-size: 11px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 10px;
    }

    .metric{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }

    .metric span{
      font-size: 11px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .metric b{
      font-size: 14px;
      font-weight: 800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }

    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(45,212,191,.9), rgba(96,165,250,.8));
      border-radius:999px;
      transition: width .5s ease;
    }

    footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width:0;
    }

    .foot-left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }

    .foot-left .small{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .foot-left .tiny{
      color: var(--muted2);
      font-size: 11px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .seg{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color: var(--muted);
    }

    .toggle input{
      appearance:none;
      width:44px;
      height:26px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      position:relative;
      outline:none;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }

    .toggle input:focus-visible{ box-shadow: var(--ring); }
    .toggle input::after{
      content:"";
      width:20px;
      height:20px;
      position:absolute;
      top:50%;
      left:3px;
      transform: translateY(-50%);
      border-radius:999px;
      background: rgba(255,255,255,.92);
      transition: left .18s ease, background .15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    .toggle input:checked{
      background: rgba(45,212,191,.20);
      border-color: rgba(45,212,191,.35);
    }

    .toggle input:checked::after{
      left: 21px;
      background: rgba(45,212,191,.92);
    }

    .rot270{
      position:fixed;
      inset:0;
      transform: rotate(270deg);
      transform-origin: center center;
      width:100vh;
      height:100vw;
      left: calc((100vw - 100vh) / 2);
      top: calc((100vh - 100vw) / 2);
    }

    @media (max-width: 920px){
      main{ grid-template-columns: 1fr; }
      .side{ grid-template-rows: auto auto; }
      .kpi-row{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="rot270" id="root">
    <div class="stage" role="application" aria-label="Simulaci√≥n de alimentaci√≥n el√©ctrica de almac√©n">
      <header>
        <div class="brand">
          <div class="badge" aria-hidden="true">‚òÄÔ∏è</div>
          <div class="title">
            <h1>Monitor Solar | Almac√©n</h1>
            <div class="subtitle" id="statusLine">Simulaci√≥n activa ¬∑ Flujo en tiempo real</div>
          </div>
        </div>

        <div class="header-right">
          <div class="pill" aria-live="polite">
            <span class="dot" id="liveDot" aria-hidden="true"></span>
            <span id="lastUpdate">Cargando‚Ä¶</span>
          </div>
          <button class="btn" id="btnReset" type="button">Reiniciar</button>
        </div>
      </header>

      <main>
        <section class="panel" aria-label="Diagrama de alimentaci√≥n">
          <div class="panel-inner">
            <div class="panel-head">
              <h2>Diagrama de energ√≠a</h2>
              <small id="modeLabel">Modo: Simulaci√≥n</small>
            </div>

            <div class="diagram-wrap">
              <div class="diagram" aria-label="Diagrama SVG con flujos">
                <svg viewBox="0 0 1200 640" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Flujo Solar hacia inversor, bater√≠a, red y consumo del almac√©n">
                  <defs>
                    <linearGradient id="gSolar" x1="0" x2="1">
                      <stop offset="0" stop-color="rgba(251,191,36,.95)"/>
                      <stop offset="1" stop-color="rgba(96,165,250,.85)"/>
                    </linearGradient>

                    <linearGradient id="gGrid" x1="0" x2="1">
                      <stop offset="0" stop-color="rgba(96,165,250,.95)"/>
                      <stop offset="1" stop-color="rgba(167,139,250,.85)"/>
                    </linearGradient>

                    <linearGradient id="gLoad" x1="0" x2="1">
                      <stop offset="0" stop-color="rgba(45,212,191,.95)"/>
                      <stop offset="1" stop-color="rgba(96,165,250,.80)"/>
                    </linearGradient>

                    <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
                      <feGaussianBlur stdDeviation="6" result="b"/>
                      <feColorMatrix in="b" type="matrix"
                        values="1 0 0 0 0
                                0 1 0 0 0
                                0 0 1 0 0
                                0 0 0 .35 0" result="s"/>
                      <feMerge>
                        <feMergeNode in="s"/>
                        <feMergeNode in="SourceGraphic"/>
                      </feMerge>
                    </filter>

                    <path id="pSolarToInv" d="M 210 210 C 360 210, 420 210, 500 210" />
                    <path id="pGridToInv"  d="M 210 430 C 360 430, 420 430, 500 430" />
                    <path id="pInvToLoad"  d="M 700 320 C 820 320, 900 320, 1020 320" />
                    <path id="pInvToBat"   d="M 620 240 C 620 260, 620 280, 620 300" />
                    <path id="pBatToInv"   d="M 620 400 C 620 380, 620 360, 620 340" />

                    <marker id="arrow" viewBox="0 0 12 12" refX="10" refY="6" markerWidth="10" markerHeight="10" orient="auto-start-reverse">
                      <path d="M 0 0 L 12 6 L 0 12 z" fill="rgba(255,255,255,.75)"></path>
                    </marker>
                  </defs>

                  <rect x="22" y="22" width="1156" height="596" rx="20" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.10)"/>

                  <g filter="url(#soft)">
                    <g>
                      <rect x="70" y="120" width="240" height="180" rx="18" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.14)"/>
                      <text x="92" y="155" fill="rgba(255,255,255,.92)" font-size="18" font-weight="800">Placas solares</text>
                      <text x="92" y="188" fill="rgba(255,255,255,.65)" font-size="13">Producci√≥n</text>
                      <text x="92" y="224" fill="rgba(255,255,255,.95)" font-size="40" font-weight="900" id="svgSolarKw">0.0</text>
                      <text x="198" y="224" fill="rgba(255,255,255,.70)" font-size="18" font-weight="700">kW</text>

                      <g opacity=".9">
                        <circle cx="252" cy="158" r="22" fill="rgba(251,191,36,.20)" stroke="rgba(251,191,36,.45)"/>
                        <text x="244" y="165" fill="rgba(251,191,36,.95)" font-size="20">‚òÄ</text>
                      </g>
                    </g>

                    <g>
                      <rect x="70" y="340" width="240" height="180" rx="18" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.14)"/>
                      <text x="92" y="375" fill="rgba(255,255,255,.92)" font-size="18" font-weight="800">Red el√©ctrica</text>
                      <text x="92" y="408" fill="rgba(255,255,255,.65)" font-size="13">Compra / Apoyo</text>
                      <text x="92" y="444" fill="rgba(255,255,255,.95)" font-size="40" font-weight="900" id="svgGridKw">0.0</text>
                      <text x="198" y="444" fill="rgba(255,255,255,.70)" font-size="18" font-weight="700">kW</text>

                      <g opacity=".9">
                        <circle cx="252" cy="378" r="22" fill="rgba(96,165,250,.16)" stroke="rgba(96,165,250,.40)"/>
                        <text x="244" y="386" fill="rgba(96,165,250,.95)" font-size="18">‚ö°</text>
                      </g>
                    </g>

                    <g>
                      <rect x="470" y="190" width="300" height="260" rx="18" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.16)"/>
                      <text x="492" y="228" fill="rgba(255,255,255,.92)" font-size="18" font-weight="800">Inversor / Gesti√≥n</text>
                      <text x="492" y="258" fill="rgba(255,255,255,.65)" font-size="13">Distribuci√≥n de energ√≠a</text>

                      <rect x="492" y="290" width="256" height="16" rx="999" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.12)"/>
                      <rect x="492" y="290" width="0" height="16" rx="999" fill="url(#gLoad)" id="svgInvBar"/>

                      <text x="492" y="345" fill="rgba(255,255,255,.80)" font-size="12">Carga del inversor</text>
                      <text x="492" y="382" fill="rgba(255,255,255,.95)" font-size="34" font-weight="900" id="svgInvPct">0</text>
                      <text x="540" y="382" fill="rgba(255,255,255,.70)" font-size="16" font-weight="700">%</text>

                      <g opacity=".9">
                        <circle cx="732" cy="226" r="20" fill="rgba(45,212,191,.14)" stroke="rgba(45,212,191,.40)"/>
                        <text x="724" y="233" fill="rgba(45,212,191,.95)" font-size="16">‚éì</text>
                      </g>
                    </g>

                    <g>
                      <rect x="520" y="470" width="200" height="130" rx="18" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.14)"/>
                      <text x="542" y="505" fill="rgba(255,255,255,.92)" font-size="16" font-weight="800">Bater√≠a</text>
                      <text x="542" y="530" fill="rgba(255,255,255,.65)" font-size="12">Estado de carga</text>

                      <rect x="542" y="548" width="156" height="18" rx="8" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.12)"/>
                      <rect x="542" y="548" width="0" height="18" rx="8" fill="url(#gSolar)" id="svgBatBar"/>

                      <text x="542" y="592" fill="rgba(255,255,255,.95)" font-size="26" font-weight="900" id="svgBatPct">0</text>
                      <text x="578" y="592" fill="rgba(255,255,255,.70)" font-size="14" font-weight="700">%</text>
                    </g>

                    <g>
                      <rect x="900" y="230" width="240" height="220" rx="18" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.16)"/>
                      <text x="922" y="268" fill="rgba(255,255,255,.92)" font-size="18" font-weight="800">Almac√©n</text>
                      <text x="922" y="298" fill="rgba(255,255,255,.65)" font-size="13">Consumo total</text>

                      <text x="922" y="345" fill="rgba(255,255,255,.95)" font-size="42" font-weight="900" id="svgLoadKw">0.0</text>
                      <text x="1030" y="345" fill="rgba(255,255,255,.70)" font-size="18" font-weight="700">kW</text>

                      <text x="922" y="388" fill="rgba(255,255,255,.65)" font-size="12">Autoconsumo</text>
                      <text x="922" y="418" fill="rgba(255,255,255,.92)" font-size="20" font-weight="900" id="svgSelfPct">0</text>
                      <text x="952" y="418" fill="rgba(255,255,255,.65)" font-size="12">%</text>

                      <g opacity=".9">
                        <circle cx="1102" cy="268" r="20" fill="rgba(167,139,250,.14)" stroke="rgba(167,139,250,.40)"/>
                        <text x="1094" y="275" fill="rgba(167,139,250,.95)" font-size="16">üè≠</text>
                      </g>
                    </g>
                  </g>

                  <g fill="none" stroke="rgba(255,255,255,.18)" stroke-width="6" stroke-linecap="round" marker-end="url(#arrow)" opacity=".65">
                    <use href="#pSolarToInv"/>
                    <use href="#pGridToInv"/>
                    <use href="#pInvToLoad"/>
                    <path d="M 620 450 C 620 455, 620 462, 620 470" />
                    <path d="M 620 470 C 620 455, 620 445, 620 440" opacity="0"/>
                  </g>

                  <g id="flowSolar" opacity="0">
                    <circle r="7" fill="url(#gSolar)">
                      <animateMotion dur="2.2s" repeatCount="indefinite" path="M 210 210 C 360 210, 420 210, 500 210"/>
                    </circle>
                    <circle r="5" fill="rgba(251,191,36,.9)">
                      <animateMotion dur="2.2s" begin="0.7s" repeatCount="indefinite" path="M 210 210 C 360 210, 420 210, 500 210"/>
                    </circle>
                  </g>

                  <g id="flowGrid" opacity="0">
                    <circle r="7" fill="url(#gGrid)">
                      <animateMotion dur="2.4s" repeatCount="indefinite" path="M 210 430 C 360 430, 420 430, 500 430"/>
                    </circle>
                    <circle r="5" fill="rgba(96,165,250,.95)">
                      <animateMotion dur="2.4s" begin="0.9s" repeatCount="indefinite" path="M 210 430 C 360 430, 420 430, 500 430"/>
                    </circle>
                  </g>

                  <g id="flowToLoad" opacity="0">
                    <circle r="7" fill="url(#gLoad)">
                      <animateMotion dur="2.0s" repeatCount="indefinite" path="M 700 320 C 820 320, 900 320, 1020 320"/>
                    </circle>
                    <circle r="5" fill="rgba(45,212,191,.95)">
                      <animateMotion dur="2.0s" begin="0.6s" repeatCount="indefinite" path="M 700 320 C 820 320, 900 320, 1020 320"/>
                    </circle>
                  </g>

                  <g id="flowToBat" opacity="0">
                    <circle r="6" fill="url(#gSolar)">
                      <animateMotion dur="1.6s" repeatCount="indefinite" path="M 620 270 C 620 300, 620 330, 620 360"/>
                    </circle>
                    <circle r="4" fill="rgba(251,191,36,.95)">
                      <animateMotion dur="1.6s" begin="0.55s" repeatCount="indefinite" path="M 620 270 C 620 300, 620 330, 620 360"/>
                    </circle>
                  </g>

                  <g id="flowFromBat" opacity="0">
                    <circle r="6" fill="url(#gLoad)">
                      <animateMotion dur="1.6s" repeatCount="indefinite" path="M 620 430 C 620 400, 620 370, 620 340"/>
                    </circle>
                    <circle r="4" fill="rgba(45,212,191,.95)">
                      <animateMotion dur="1.6s" begin="0.55s" repeatCount="indefinite" path="M 620 430 C 620 400, 620 370, 620 340"/>
                    </circle>
                  </g>
                </svg>
              </div>

              <div class="kpi-row" aria-label="KPIs principales">
                <div class="kpi">
                  <div class="label">Producci√≥n solar</div>
                  <div class="value"><span id="kpiSolar">0.0</span> kW</div>
                  <div class="sub"><span>Hoy</span><span><span id="kpiSolarKwh">0.0</span> kWh</span></div>
                </div>
                <div class="kpi">
                  <div class="label">Consumo almac√©n</div>
                  <div class="value"><span id="kpiLoad">0.0</span> kW</div>
                  <div class="sub"><span>Hoy</span><span><span id="kpiLoadKwh">0.0</span> kWh</span></div>
                </div>
                <div class="kpi">
                  <div class="label">Compra a red</div>
                  <div class="value"><span id="kpiGrid">0.0</span> kW</div>
                  <div class="sub"><span>Autoconsumo</span><span><span id="kpiSelf">0</span>%</span></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <aside class="side" aria-label="Paneles de detalle">
          <section class="panel" aria-label="Detalle de planta y consumo">
            <div class="panel-inner">
              <div class="panel-head">
                <h2>Detalle</h2>
                <small id="siteName">El Sebadal</small>
              </div>
              <div class="cards">
                <div class="card">
                  <div class="card-top">
                    <strong>Distribuci√≥n instant√°nea</strong>
                    <span class="chip" id="chipBalance">Balance OK</span>
                  </div>
                  <div class="grid">
                    <div class="metric">
                      <span>Solar ‚Üí Carga</span>
                      <b><span id="mSolarToLoad">0.0</span> kW</b>
                    </div>
                    <div class="metric">
                      <span>Red ‚Üí Carga</span>
                      <b><span id="mGridToLoad">0.0</span> kW</b>
                    </div>
                    <div class="metric">
                      <span>Solar ‚Üí Bater√≠a</span>
                      <b><span id="mSolarToBat">0.0</span> kW</b>
                    </div>
                    <div class="metric">
                      <span>Bater√≠a ‚Üí Carga</span>
                      <b><span id="mBatToLoad">0.0</span> kW</b>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-top">
                    <strong>Bater√≠a</strong>
                    <span class="chip" id="chipBat">SOC</span>
                  </div>
                  <div class="grid">
                    <div class="metric">
                      <span>Estado</span>
                      <b><span id="mBatSoc">0</span>%</b>
                    </div>
                    <div class="metric">
                      <span>Potencia</span>
                      <b><span id="mBatKw">0.0</span> kW</b>
                    </div>
                  </div>
                  <div class="bar" role="progressbar" aria-label="Estado de carga de bater√≠a" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                    <i id="batBar"></i>
                  </div>
                </div>

                <div class="card">
                  <div class="card-top">
                    <strong>Autoconsumo</strong>
                    <span class="chip" id="chipSelf">%</span>
                  </div>
                  <div class="grid">
                    <div class="metric">
                      <span>Instant√°neo</span>
                      <b><span id="mSelfPct">0</span>%</b>
                    </div>
                    <div class="metric">
                      <span>Compra a red</span>
                      <b><span id="mGridPct">0</span>%</b>
                    </div>
                  </div>
                  <div class="bar" role="progressbar" aria-label="Autoconsumo" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                    <i id="selfBar"></i>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="panel" aria-label="Control de modo y fuente de datos">
            <div class="panel-inner">
              <div class="panel-head">
                <h2>Control</h2>
                <small id="controlHint">Simulaci√≥n o datos.json</small>
              </div>
              <div class="cards">
                <div class="card">
                  <div class="card-top">
                    <strong>Modo</strong>
                    <span class="chip" id="chipMode">Simulaci√≥n</span>
                  </div>
                  <label class="toggle" for="chkLive">
                    <span>Usar datos reales (datos.json)</span>
                    <input id="chkLive" type="checkbox" />
                  </label>
                  <div class="grid">
                    <div class="metric">
                      <span>Intervalo</span>
                      <b><span id="mInterval">1.0</span>s</b>
                    </div>
                    <div class="metric">
                      <span>Refresco datos.json</span>
                      <b><span id="mFetch">70</span>s</b>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-top">
                    <strong>Perfil de consumo</strong>
                    <span class="chip" id="chipProfile">Almac√©n</span>
                  </div>
                  <div class="grid">
                    <button class="btn" type="button" data-profile="almacen">Almac√©n</button>
                    <button class="btn" type="button" data-profile="picos">Picos</button>
                    <button class="btn" type="button" data-profile="noche">Noche</button>
                    <button class="btn" type="button" data-profile="estable">Estable</button>
                  </div>
                </div>

                <div class="card">
                  <div class="card-top">
                    <strong>Escala</strong>
                    <span class="chip" id="chipScale">kW</span>
                  </div>
                  <div class="grid">
                    <div class="metric">
                      <span>Solar m√°x</span>
                      <b><span id="mSolarMax">90</span> kW</b>
                    </div>
                    <div class="metric">
                      <span>Carga m√°x</span>
                      <b><span id="mLoadMax">120</span> kW</b>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </aside>
      </main>

      <footer>
        <div class="foot-left">
          <div class="small" id="footLine">Balance: Solar + Red + Bater√≠a = Consumo</div>
          <div class="tiny" id="footSub">Flujos animados seg√∫n reparto instant√°neo</div>
        </div>

        <div class="seg">
          <span class="pill" aria-label="Reloj de simulaci√≥n">
            <span style="opacity:.85">‚è±</span>
            <span id="simClock">00:00</span>
          </span>
        </div>
      </footer>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id)

    const ui = {
      lastUpdate: $("lastUpdate"),
      statusLine: $("statusLine"),
      modeLabel: $("modeLabel"),
      siteName: $("siteName"),
      liveDot: $("liveDot"),
      chkLive: $("chkLive"),
      btnReset: $("btnReset"),

      kpiSolar: $("kpiSolar"),
      kpiSolarKwh: $("kpiSolarKwh"),
      kpiLoad: $("kpiLoad"),
      kpiLoadKwh: $("kpiLoadKwh"),
      kpiGrid: $("kpiGrid"),
      kpiSelf: $("kpiSelf"),

      svgSolarKw: $("svgSolarKw"),
      svgGridKw: $("svgGridKw"),
      svgLoadKw: $("svgLoadKw"),
      svgSelfPct: $("svgSelfPct"),
      svgInvPct: $("svgInvPct"),
      svgInvBar: $("svgInvBar"),
      svgBatPct: $("svgBatPct"),
      svgBatBar: $("svgBatBar"),

      flowSolar: $("flowSolar"),
      flowGrid: $("flowGrid"),
      flowToLoad: $("flowToLoad"),
      flowToBat: $("flowToBat"),
      flowFromBat: $("flowFromBat"),

      mSolarToLoad: $("mSolarToLoad"),
      mGridToLoad: $("mGridToLoad"),
      mSolarToBat: $("mSolarToBat"),
      mBatToLoad: $("mBatToLoad"),

      mBatSoc: $("mBatSoc"),
      mBatKw: $("mBatKw"),
      batBar: $("batBar"),

      mSelfPct: $("mSelfPct"),
      mGridPct: $("mGridPct"),
      selfBar: $("selfBar"),

      chipBalance: $("chipBalance"),
      chipBat: $("chipBat"),
      chipSelf: $("chipSelf"),
      chipMode: $("chipMode"),
      chipProfile: $("chipProfile"),

      mInterval: $("mInterval"),
      mFetch: $("mFetch"),
      mSolarMax: $("mSolarMax"),
      mLoadMax: $("mLoadMax"),

      footLine: $("footLine"),
      footSub: $("footSub"),
      simClock: $("simClock"),
      root: $("root"),
    }

    const clamp = (n, a, b) => Math.max(a, Math.min(b, n))
    const round1 = (n) => Math.round(n * 10) / 10
    const round0 = (n) => Math.round(n)
    const pad2 = (n) => String(n).padStart(2, "0")

    const cfg = {
      tickMs: 1000,
      fetchMs: 70000,
      solarMax: 90,
      loadMax: 120,
      batCapacityKwh: 180,
      batMaxChargeKw: 40,
      batMaxDischargeKw: 40,
      socMin: 15,
      socMax: 95,
    }

    const state = {
      useLive: false,
      profile: "almacen",
      t0: Date.now(),
      simSec: 0,

      solarKw: 0,
      loadKw: 0,
      gridKw: 0,
      batKw: 0,
      batSoc: 62,

      solarToLoadKw: 0,
      gridToLoadKw: 0,
      solarToBatKw: 0,
      batToLoadKw: 0,

      solarKwhToday: 0,
      loadKwhToday: 0,
      lastTs: 0,
      lastUpdatedLabel: "",
    }

    function setChip(el, text, tone){
      el.textContent = text
      el.style.borderColor = "rgba(255,255,255,.12)"
      el.style.background = "rgba(255,255,255,.05)"
      el.style.color = "rgba(255,255,255,.75)"

      if(tone === "ok"){
        el.style.borderColor = "rgba(45,212,191,.35)"
        el.style.background = "rgba(45,212,191,.12)"
        el.style.color = "rgba(45,212,191,.95)"
      }
      if(tone === "warn"){
        el.style.borderColor = "rgba(251,191,36,.38)"
        el.style.background = "rgba(251,191,36,.12)"
        el.style.color = "rgba(251,191,36,.95)"
      }
      if(tone === "bad"){
        el.style.borderColor = "rgba(251,113,133,.40)"
        el.style.background = "rgba(251,113,133,.12)"
        el.style.color = "rgba(251,113,133,.95)"
      }
      if(tone === "blue"){
        el.style.borderColor = "rgba(96,165,250,.40)"
        el.style.background = "rgba(96,165,250,.12)"
        el.style.color = "rgba(96,165,250,.95)"
      }
    }

    function updateRotation(){
      const portrait = window.innerHeight > window.innerWidth
      ui.root.style.transform = portrait ? "rotate(270deg)" : "none"
      ui.root.style.width = portrait ? "100vh" : "100%"
      ui.root.style.height = portrait ? "100vw" : "100%"
      ui.root.style.left = portrait ? "calc((100vw - 100vh) / 2)" : "0"
      ui.root.style.top = portrait ? "calc((100vh - 100vw) / 2)" : "0"
    }

    function profLoadFactor(t){
      const base = (() => {
        if(state.profile === "estable") return 0.62 + 0.04*Math.sin(t/17)
        if(state.profile === "noche") return 0.32 + 0.05*Math.sin(t/19)
        if(state.profile === "picos") return 0.55 + 0.28*Math.max(0, Math.sin(t/8)) + 0.08*Math.sin(t/3.7)
        return 0.48 + 0.18*Math.max(0, Math.sin(t/10)) + 0.08*Math.sin(t/4.2)
      })()
      return clamp(base, 0.18, 0.95)
    }

    function profSolarFactor(t){
      const dayWave = 0.55 + 0.45*Math.max(0, Math.sin((t % 3600) / 3600 * Math.PI))
      const clouds = 0.88 + 0.12*Math.sin(t/13) + 0.08*Math.sin(t/5.7)
      const factor = clamp(dayWave * clamp(clouds, 0.65, 1.08), 0, 1.05)
      return factor
    }

    function stepSim(dtSec){
      const t = state.simSec
      const solar = cfg.solarMax * profSolarFactor(t)
      const load = cfg.loadMax * profLoadFactor(t)

      const soc = state.batSoc
      const canCharge = soc < cfg.socMax
      const canDischarge = soc > cfg.socMin

      let solarToLoad = Math.min(solar, load)
      let remainingLoad = load - solarToLoad

      let solarExcess = solar - solarToLoad
      let solarToBat = 0
      if(solarExcess > 0 && canCharge){
        solarToBat = Math.min(solarExcess, cfg.batMaxChargeKw)
      }

      let batToLoad = 0
      if(remainingLoad > 0 && canDischarge){
        batToLoad = Math.min(remainingLoad, cfg.batMaxDischargeKw)
        remainingLoad -= batToLoad
      }

      const gridToLoad = Math.max(0, remainingLoad)

      const batKw = solarToBat > 0 ? solarToBat : -batToLoad

      const batDeltaKwh = (batKw * dtSec) / 3600
      const batEnergyKwh = (soc/100) * cfg.batCapacityKwh
      const nextEnergy = clamp(batEnergyKwh + batDeltaKwh, 0, cfg.batCapacityKwh)
      const nextSoc = (nextEnergy / cfg.batCapacityKwh) * 100

      state.solarKw = round1(solar)
      state.loadKw = round1(load)
      state.gridKw = round1(gridToLoad)
      state.batKw = round1(batKw)
      state.batSoc = round0(nextSoc)

      state.solarToLoadKw = round1(solarToLoad)
      state.solarToBatKw = round1(solarToBat)
      state.batToLoadKw = round1(batToLoad)
      state.gridToLoadKw = round1(gridToLoad)

      state.solarKwhToday = round1(state.solarKwhToday + (state.solarKw * dtSec)/3600)
      state.loadKwhToday = round1(state.loadKwhToday + (state.loadKw * dtSec)/3600)

      state.lastUpdatedLabel = new Date().toLocaleString("es-ES", {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      })
      state.lastTs = Date.now()
    }

    function mapFromLive(json){
      const totalPot = Number(json?.total?.potencia ?? 0)
      const energiaHoy = Number(json?.total?.energia_hoy ?? 0)
      const energiaTotal = Number(json?.total?.energia_total ?? 0)

      const sebadalPot = Number(json?.sebadal?.potencia ?? totalPot ?? 0)
      const usoTotal = Number(json?.sebadal?.uso_total ?? 0)
      const prodTotal = Number(json?.sebadal?.produccion_total ?? 0)
      const energiaHoyKwh = Number(json?.total?.energia_hoy ?? 0)
      const compraRedPct = Number(json?.sebadal?.compra_red ?? 0)
      const actualizado = String(json?.actualizado ?? "")

      const loadKw = clamp(sebadalPot * (0.85 + 0.2*Math.sin((Date.now()/1000)/9)), 0, cfg.loadMax)
      const gridPct = clamp(compraRedPct, 0, 100)
      const gridKw = round1(loadKw * (gridPct / 100))
      const solarKw = round1(Math.max(0, loadKw - gridKw))

      state.solarKw = round1(solarKw)
      state.loadKw = round1(loadKw)
      state.gridKw = round1(gridKw)
      state.batKw = 0

      const selfPct = loadKw > 0 ? clamp(((loadKw - gridKw)/loadKw)*100, 0, 100) : 0
      const targetSoc = clamp(60 + 25*Math.sin((Date.now()/1000)/60), 20, 95)
      state.batSoc = round0(targetSoc)

      state.solarToLoadKw = round1(Math.min(state.solarKw, state.loadKw))
      state.gridToLoadKw = round1(state.gridKw)
      state.solarToBatKw = 0
      state.batToLoadKw = 0

      state.solarKwhToday = round1(prodTotal || energiaHoyKwh || state.solarKwhToday)
      state.loadKwhToday = round1(usoTotal || state.loadKwhToday)

      state.lastUpdatedLabel = actualizado ? `√öltima actualizaci√≥n: ${actualizado}` : `√öltima actualizaci√≥n: ${new Date().toLocaleString("es-ES")}`
      state.lastTs = Date.now()

      ui.siteName.textContent = "El Sebadal"
      ui.footSub.textContent = energiaTotal ? `Energ√≠a total acumulada: ${energiaTotal} kWh` : "Flujos animados seg√∫n reparto instant√°neo"
      return { ok: true }
    }

    async function tryFetchLive(){
      try{
        const res = await fetch("datos.json?ts=" + Date.now(), { cache:"no-store" })
        if(!res.ok) throw new Error("http " + res.status)
        const json = await res.json()
        return mapFromLive(json)
      }catch(e){
        return { ok: false }
      }
    }

    function setFlowVis(el, on){
      el.style.opacity = on ? "1" : "0"
    }

    function render(){
      const solar = state.solarKw
      const load = state.loadKw
      const grid = state.gridKw
      const soc = state.batSoc
      const batKw = state.batKw

      const selfPct = load > 0 ? clamp(((load - grid)/load)*100, 0, 100) : 0
      const gridPct = 100 - selfPct

      ui.kpiSolar.textContent = solar.toFixed(1)
      ui.kpiSolarKwh.textContent = state.solarKwhToday.toFixed(1)
      ui.kpiLoad.textContent = load.toFixed(1)
      ui.kpiLoadKwh.textContent = state.loadKwhToday.toFixed(1)
      ui.kpiGrid.textContent = grid.toFixed(1)
      ui.kpiSelf.textContent = String(round0(selfPct))

      ui.svgSolarKw.textContent = solar.toFixed(1)
      ui.svgGridKw.textContent = grid.toFixed(1)
      ui.svgLoadKw.textContent = load.toFixed(1)
      ui.svgSelfPct.textContent = String(round0(selfPct))

      const invPct = round0(clamp((load / cfg.loadMax) * 100, 0, 100))
      ui.svgInvPct.textContent = String(invPct)
      ui.svgInvBar.setAttribute("width", String(2.56 * invPct))
      ui.svgBatPct.textContent = String(soc)
      ui.svgBatBar.setAttribute("width", String(1.56 * soc))

      ui.mSolarToLoad.textContent = state.solarToLoadKw.toFixed(1)
      ui.mGridToLoad.textContent = state.gridToLoadKw.toFixed(1)
      ui.mSolarToBat.textContent = state.solarToBatKw.toFixed(1)
      ui.mBatToLoad.textContent = state.batToLoadKw.toFixed(1)

      ui.mBatSoc.textContent = String(soc)
      ui.mBatKw.textContent = Math.abs(batKw).toFixed(1)

      ui.batBar.style.width = `${soc}%`
      ui.batBar.parentElement.setAttribute("aria-valuenow", String(soc))

      ui.mSelfPct.textContent = String(round0(selfPct))
      ui.mGridPct.textContent = String(round0(gridPct))
      ui.selfBar.style.width = `${selfPct}%`
      ui.selfBar.parentElement.setAttribute("aria-valuenow", String(round0(selfPct)))

      const balance = (state.solarToLoadKw + state.gridToLoadKw + state.batToLoadKw) - load
      const balanceAbs = Math.abs(balance)
      if(balanceAbs <= 0.8){
        setChip(ui.chipBalance, "Balance OK", "ok")
      }else if(balanceAbs <= 2.5){
        setChip(ui.chipBalance, "Balance Ajustando", "warn")
      }else{
        setChip(ui.chipBalance, "Balance Inestable", "bad")
      }

      if(soc <= cfg.socMin + 5) setChip(ui.chipBat, "SOC Bajo", "warn")
      else if(soc >= cfg.socMax - 5) setChip(ui.chipBat, "SOC Alto", "blue")
      else setChip(ui.chipBat, "SOC Normal", "ok")

      setChip(ui.chipSelf, `${round0(selfPct)}%`, selfPct >= 80 ? "ok" : selfPct >= 50 ? "warn" : "bad")

      ui.lastUpdate.textContent = state.useLive
        ? (state.lastUpdatedLabel || "√öltima actualizaci√≥n: ‚Äî")
        : (state.lastUpdatedLabel ? `√öltima actualizaci√≥n: ${state.lastUpdatedLabel}` : "√öltima actualizaci√≥n: ‚Äî")

      const solarOn = state.solarKw > 1.2
      const gridOn = state.gridKw > 0.8
      const toLoadOn = state.loadKw > 1.2
      const toBatOn = state.solarToBatKw > 0.8
      const fromBatOn = state.batToLoadKw > 0.8

      setFlowVis(ui.flowSolar, solarOn)
      setFlowVis(ui.flowGrid, gridOn)
      setFlowVis(ui.flowToLoad, toLoadOn)
      setFlowVis(ui.flowToBat, toBatOn)
      setFlowVis(ui.flowFromBat, fromBatOn)

      ui.liveDot.style.background = state.useLive ? "rgba(96,165,250,.95)" : "rgba(45,212,191,.95)"
      ui.liveDot.style.boxShadow = state.useLive ? "0 0 0 3px rgba(96,165,250,.18)" : "0 0 0 3px rgba(45,212,191,.18)"
      ui.modeLabel.textContent = `Modo: ${state.useLive ? "Datos reales" : "Simulaci√≥n"}`
      setChip(ui.chipMode, state.useLive ? "Datos reales" : "Simulaci√≥n", state.useLive ? "blue" : "ok")

      ui.statusLine.textContent = state.useLive
        ? "Datos reales activos ¬∑ Animaci√≥n derivada"
        : "Simulaci√≥n activa ¬∑ Flujo en tiempo real"

      const mm = Math.floor(state.simSec / 60)
      const ss = state.simSec % 60
      ui.simClock.textContent = `${pad2(mm)}:${pad2(ss)}`

      ui.footLine.textContent = `Balance: Solar ${solar.toFixed(1)} kW ¬∑ Bater√≠a ${batKw.toFixed(1)} kW ¬∑ Red ${grid.toFixed(1)} kW ‚Üí Consumo ${load.toFixed(1)} kW`
    }

    function reset(){
      state.simSec = 0
      state.solarKwhToday = 0
      state.loadKwhToday = 0
      state.batSoc = 62
      state.lastUpdatedLabel = ""
      state.lastTs = 0
    }

    function setProfile(p){
      state.profile = p
      const name = p === "picos" ? "Picos" : p === "noche" ? "Noche" : p === "estable" ? "Estable" : "Almac√©n"
      setChip(ui.chipProfile, name, p === "noche" ? "blue" : p === "picos" ? "warn" : "ok")
    }

    async function tick(){
      state.simSec += 1

      if(state.useLive){
        const r = await tryFetchLive()
        if(!r.ok){
          ui.lastUpdate.textContent = "Error cargando datos.json"
          setChip(ui.chipMode, "Error datos", "bad")
        }
      }else{
        stepSim(1)
      }

      render()
    }

    function bind(){
      ui.chkLive.addEventListener("change", async (e) => {
        state.useLive = !!e.target.checked
        if(state.useLive){
          const r = await tryFetchLive()
          if(!r.ok){
            state.useLive = false
            ui.chkLive.checked = false
            ui.lastUpdate.textContent = "No se pudo leer datos.json"
            setChip(ui.chipMode, "Simulaci√≥n", "ok")
          }
        }else{
          reset()
        }
        render()
      })

      ui.btnReset.addEventListener("click", () => {
        reset()
        render()
      })

      document.querySelectorAll("[data-profile]").forEach(btn => {
        btn.addEventListener("click", () => {
          setProfile(btn.getAttribute("data-profile"))
        })
      })

      window.addEventListener("resize", updateRotation)
    }

    ui.mInterval.textContent = String((cfg.tickMs/1000).toFixed(1))
    ui.mFetch.textContent = String(round0(cfg.fetchMs/1000))

    updateRotation()
    bind()
    setProfile("almacen")
    reset()
    stepSim(1)
    render()
    setInterval(tick, cfg.tickMs)
  </script>
</body>
</html>
```
